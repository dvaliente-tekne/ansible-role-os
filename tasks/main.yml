---
# =============================================================================
# System Configuration
# =============================================================================

- name: Ensure reflector config directory exists
  ansible.builtin.file:
    path: /etc/xdg/reflector
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - os
    - system_config

- name: Copy reflector.conf to system
  ansible.builtin.copy:
    src: reflector.conf
    dest: /etc/xdg/reflector/reflector.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - os
    - system_config

# Locale Configuration
- name: Set system locale
  ansible.builtin.lineinfile:
    path: /etc/locale.conf
    state: present
    line: "LANG={{ os_locale }}"
    create: true
    mode: '0644'
  tags:
    - os
    - locale

- name: Enable locale in locale.gen
  ansible.builtin.lineinfile:
    path: /etc/locale.gen
    regexp: '^#?{{ os_locale | regex_escape }}'
    line: "{{ os_locale }} UTF-8"
  notify: Generate locales
  tags:
    - os
    - locale

- name: Flush handlers to run locale-gen now
  ansible.builtin.meta: flush_handlers
  tags:
    - os
    - locale

# =============================================================================
# Network Configuration
# =============================================================================
# Order: deploy templates first, then flush handlers, then enable/restart
# services so they load the new config before WiFi connect.

- name: Copy WiFi network configuration
  ansible.builtin.template:
    src: 80-wifi-station.network.j2
    dest: /etc/systemd/network/80-wifi-station.network
    owner: root
    group: root
    mode: '0644'
  when: os_hostname in os_network_hosts
  notify: Restart systemd-networkd
  tags:
    - os
    - network

- name: Copy Ethernet network configuration
  ansible.builtin.template:
    src: 89-ethernet.network.j2
    dest: /etc/systemd/network/89-ethernet.network
    owner: root
    group: root
    mode: '0644'
  when: os_hostname in os_network_hosts
  notify: Restart systemd-networkd
  tags:
    - os
    - network

- name: Flush handlers so networkd restarts with new config before enabling WiFi
  ansible.builtin.meta: flush_handlers
  tags:
    - os
    - network

- name: Enable and restart iwd (ASTER only)
  ansible.builtin.systemd:
    name: iwd.service
    enabled: true
    state: restarted
  when: os_hostname == 'ASTER'
  tags:
    - os
    - network
    - wifi

- name: Enable and restart systemd-networkd
  ansible.builtin.systemd:
    name: systemd-networkd.service
    enabled: true
    state: restarted
  tags:
    - os
    - network

- name: Enable and restart systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved.service
    enabled: true
    state: restarted
  tags:
    - os
    - network

- name: Require WiFi passphrase for ASTER
  ansible.builtin.assert:
    that:
      - os_wifi_passphrase is defined
      - os_wifi_passphrase | length > 0
    fail_msg: "os_wifi_passphrase must be set (e.g. in vault) for ASTER WiFi connection."
  when: os_hostname == 'ASTER'
  tags:
    - os
    - network
    - wifi

- name: Connect to WiFi network (ASTER only)
  ansible.builtin.command:
    argv:
      - /usr/bin/iwctl
      - station
      - wlan0
      - connect
      - "{{ os_wifi_ssid }}"
      - --passphrase
      - "{{ os_wifi_passphrase }}"
  when: os_hostname == 'ASTER'
  changed_when: false
  failed_when: false
  no_log: true
  tags:
    - os
    - network
    - wifi

# =============================================================================
# Wait for Network Connectivity
# =============================================================================

- name: Flush handlers to restart networkd if config changed
  ansible.builtin.meta: flush_handlers
  tags:
    - os
    - network

- name: Wait for network connectivity
  ansible.builtin.command:
    cmd: ping -c 1 -W 2 archlinux.org
  register: network_check
  until: network_check.rc == 0
  retries: 30
  delay: 2
  changed_when: false
  tags:
    - os
    - network

# =============================================================================
# NTP Configuration (requires network)
# =============================================================================

- name: Enable NTP synchronization
  ansible.builtin.command:
    cmd: /usr/bin/timedatectl set-ntp true
  changed_when: false
  tags:
    - os
    - ntp

# =============================================================================
# Mirror Configuration (requires network to be up)
# =============================================================================

- name: Update pacman mirrorlist
  ansible.builtin.command:
    cmd: >-
      /usr/bin/reflector
      --country '{{ os_mirror_country }}'
      --latest {{ os_mirror_count }}
      --sort rate
      --protocol {{ os_mirror_protocols }}
      --age {{ os_mirror_age }}
      --save /etc/pacman.d/mirrorlist
  changed_when: false
  tags:
    - os
    - mirrors

# =============================================================================
# System Scripts Installation
# =============================================================================

- name: Copy game script to /usr/local/bin
  ansible.builtin.copy:
    src: game
    dest: /usr/local/bin/game
    owner: root
    group: root
    mode: '0755'
  tags:
    - os
    - scripts

- name: Copy update script to /usr/local/bin
  ansible.builtin.copy:
    src: update
    dest: /usr/local/bin/update
    owner: root
    group: root
    mode: '0755'
  tags:
    - os
    - scripts

- name: Copy work script to /usr/local/bin
  ansible.builtin.copy:
    src: work
    dest: /usr/local/bin/work
    owner: root
    group: root
    mode: '0755'
  tags:
    - os
    - scripts
